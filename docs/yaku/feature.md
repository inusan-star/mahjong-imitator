# feature_comparison.md: 既存研究(GPW 2019) vs Exp4 特徴量設計の詳細比較

## 1. 関数ごとの処理とデータの持ち方の違い

各関数がどのように情報を抽出し、最終的な入力テンソルのどこに配置されるかを整理します。

### `_encode_seat_number`

- [cite_start]**既存研究**: 自分の席番号（0〜3）を1つのスカラー値として、472次元配列の先頭インデックス `[0]` に配置します [cite: 1]。
- **Exp4**: 席番号を「Global Token（35番目の行）」のベクトル内の1要素として配置します。

### `_encode_hands`

- [cite_start]**既存研究**: 手牌にある34種類の牌それぞれの枚数をカウントし、インデックス `[1-34]` に順番に並べます [cite: 1]。
- **Exp4**: 34種類の牌トークン（行 `0-33`）の第0列に、それぞれの牌の枚数を格納します。

### `_encode_discards`

- [cite_start]**既存研究**: 各プレイヤーが捨てた牌の種類と枚数をカウントします [cite: 1][cite_start]。136要素（34種×4人）として、インデックス `[35-170]` にフラットに配置されます [cite: 1][cite_start]。打牌の順序情報は無視されます [cite: 1]。
- **Exp4**: 「どの牌が、誰の河に何枚あるか」という情報を、各牌トークン（行 `0-33`）の第1〜4列（プレイヤー0〜3に対応）に分散して配置します。

### `_encode_melds` (今回の重要変更点)

- [cite_start]**既存研究**: 副露（鳴き）を16ビットの整数コード（bit-field）で表現します [cite: 1][cite_start]。4人×4メンツ×16ビットの計256要素を、インデックス `[171-426]` に配置します [cite: 1]。
- **Exp4**: 既存研究と同様に「各プレイヤー最大4つの副露」を区別します。各牌トークン（行 `0-33`）に対し、第5〜20列（4人×4メンツ = 16列）を確保し、その牌が「誰の何番目の副露に含まれているか」をフラグ立てします。加槓（ADDED_KAN）時は、元のポンのメンツ列に牌を追加します。

### `_encode_dora_indicators`

- [cite_start]**既存研究**: ドラ表示牌の種類と枚数をカウントし、34要素としてインデックス `[427-461]` に配置します [cite: 1]。
- **Exp4**: 各牌トークン（行 `0-33`）の第21列に、その牌がドラ表示牌である枚数を格納します。

### `_encode_prevailing_wind` & `_encode_own_wind`

- [cite_start]**既存研究**: 場風と自風をそれぞれ1つの数値として保持し、インデックス `[462]` と `[463]` に配置します [cite: 1]。
- **Exp4**: 2つの数値を「Global Token（35番目の行）」のベクトル内に集約します。

### `_encode_richi_players_last_round` & `_encode_richi_players`

- [cite_start]**既存研究**: 前巡にリーチしたプレイヤーと、現在リーチしているプレイヤーのフラグ（計8要素）を、インデックス `[464-471]` に配置します [cite: 1]。
- **Exp4**: これらのフラグ情報を「Global Token（35番目の行）」のベクトル内に集約します。

---

## 2. 全体構造（レイアウト）の比較

| 特徴                    | 既存研究 (GPW 2019)                                                                          | Exp4 (Proposed Transformer)                                                                  |
| :---------------------- | :------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------- |
| **形状**                | [cite_start]$1 \times 472$ (スカラーの羅列) [cite: 1]                                        | $35 \times 22$ (行列形式)                                                                    |
| **配置の論理**          | [cite_start]**項目別シーケンシャル**: 情報の種類ごとに順番に並べる [cite: 1]                 | **牌トークン軸**: 牌の種類を「行」とし、その牌の状態を「列」に集約する                       |
| **グローバル情報**      | [cite_start]配列の末尾付近に固定位置で配置 [cite: 1]                                         | 35番目の独立した「Global Token」として集約                                                   |
| **Transformerへの適性** | 牌ごとの関係（一萬と二萬の繋がり等）を計算するために、離れたインデックスを探索する必要がある | 各行が牌の意味を持つため、Self-Attentionによって牌同士の物理的・戦術的な距離を直接学習できる |

---

この設計により、既存研究で使用されている「席順」「手の形」「河」「副露」「ドラ」「風」「リーチ状況」といった全ての情報を網羅しつつ、Transformerが麻雀の「役の形」を効率的に抽出できる形式へと変換されています。
