## 1. データセット構築

### データ概要

| 項目                 | 既存研究             | 本研究                             |
| :------------------- | :------------------- | :--------------------------------- |
| **期間**             | 不明                 | 約10年間（2015年-2024年）          |
| **対象プレイヤー**   | 天鳳トッププレイヤー | 天鳳 鳳凰卓                        |
| **対象行動**         | 打牌・ポン・チー     | 打牌・ポン・チー・明槓・暗槓・加槓 |
| **データ母数**       | 不明                 | 1,586,281 試合                     |
| **学習・評価使用量** | 1,700,000 局面       | 100,000 試合                       |

### 抽出条件

- 対象局の限定
  - 既存研究: 明記なし
  - 本研究: 和了（アガリ）発生局のみを抽出
  - 理由: 流局時は最終的な正解ラベル（役構成）が不確定であり、意思決定と結果の因果関係を客観的に定義できないため。
- 対象局面の定義
  - 既存研究: 打牌・ポン・チー
  - 本研究: 和了者の視点における、配牌から和了直前までの全意思決定ステップ（打牌・副露・暗槓・加槓）を抽出。
  - 理由: 和了という結果に至るまでの過程において、プレイヤーが介在させた全ての判断を網羅的に学習させるため。また、カンの判断（暗槓・加槓・大明槓）がもたらす新ドラによる打点向上や、三槓子といった特定の役形成を狙う戦略的な選択肢を包括的に評価するため。
- 抽出対象外
  - 流局、途中流局（九種九牌、四風連打、四家立直、四槓散了、三家和）

### データ分割

- 分割単位: 同一の試合内における局面が訓練・評価データ間で混在することを防ぐため、試合単位で分割。
- 構成: 合計 100,000 試合を抽出。
  - 訓練用 (Train): 90,000 試合
  - 検証用 (Valid): 5,000 試合
  - 評価用 (Test): 5,000 試合

### 希少役分布維持のための割当手順

母集団からの単純なランダム抽出では、出現頻度が極端に低い役が評価データから消失するリスクがある。これを防ぐため、以下の数理モデルを用いて、不足している役を優先的に各セットへ割り振る手順により、全1,586,281試合から100,000試合を抽出し、各分割セットにおいて母集団の役分布を再現する。

1. 母集団からの抽出手順: 各役 $l$ の出現総数を $C_l^{total}$ としたとき、希少度を $R_l = 1 / C_l^{total}$ と定義します。また、この希少度に基づき、出現頻度が低い順にランキング $Rank_l \in \{1, 2, \dots, |L|\}$ を付与します。母集団の中から、各役の出現率を維持したまま100,000試合を抽出するため、各対局を代表役の $Rank_l$ が高い（出現頻度が低い）順に走査します。
2. 目標数 $G_{j,l}$ の算出: 各セット $j$ の割当比率 $w_j$ に対し、役 $l$ の目標数を次式で定義する。
   $$G_{j,l} = \frac{C_l^{total}}{1,586,281} \times 100,000 \times w_j$$
3. 抽出の充足判定: 役 $l$ の現在の全セットにおける合計抽出数を $Count_{all,l}$ としたとき、充足状態 $F_l$ を以下のように定義します。
   $$
   F_l =
   \begin{cases}
   1 & (\text{if } Count_{all,l} \ge \sum_j G_{j,l}) \\
   0 & (\text{otherwise})
   \end{cases}
   $$
4. 代表役 $l^*$ の選定と割当: 各試合 $h$ に含まれる役の集合 $L_h$ のうち、まだ目標数に達していない（$F_l = 0$）役の中で最も希少度が高いものを代表役 $l^*$ として選択します。
   $$l^* = \text{argmax}_{l \in \{ \lambda \in L_h \mid F_\lambda = 0 \}} (R_l)$$
   代表役 $l^*$ のセットごとの充足率 $S_{j,l^*} = Count_{j,l^*} / G_{j,l^*}$ が最も低いセット $j$ に対して試合 $h$ を割り当てます。もし集合 $\{ \lambda \in L_h \mid F_\lambda = 0 \}$ が空集合である（＝含まれる全ての役が目標数に達している）場合、その対局は希少役の抽出対象から除外します。

---

## 2. 予測対象ラベルの定義と分類基準

### 予測対象

プレイヤーの能動的な選択によって制御可能な、合計33種類の役およびドラを予測対象ラベルとする。

- 基本役（5種）: 門前清自摸和、立直、平和、断幺九、一盃口
- 構成役（13種）: 七対子、混全帯幺九、一気通貫、三色同順、三色同刻、対々和、三暗刻、小三元、混老頭、二盃口、純全帯幺九、混一色、清一色
- 役牌（10種）: 自風(東/南/西/北)、場風(東/南/西)、三元牌(白/發/中)
- ドラ（2種）: ドラ、赤ドラ
- 役満（3種）: 四暗刻、国士無双、大三元

### 除外対象

#### 1. 統計的欠損（出現極少・無）

全1,586,281試合を解析した結果、出現頻度が極めて低く、モデルの評価指標を算出するための最小サンプルサイズを確保できない役を除外する。

- 境界閾値: 出現数1,586試合未満（出現率 約0.1%未満）
- 除外の理由: 本研究では評価データ（5,000試合）において、たった1件の正誤で指標が極端に変動するのを防ぎ、統計的信頼性を担保するための境界条件を期待出現数 $n \ge 5$ と定義しました。これは評価データ全体の0.1%に相当します。この比率を母集団（1,586,281試合）に適用すると、出現数が約1,586試合を下回る役は、十分なサンプルサイズを確保できず精度の正しい測定が困難であるため、除外を決定しました。
- 母集団における出現数実績（除外例）:
  - 小四喜: 919 試合
  - 四暗刻単騎: 737 試合
  - 字一色: 180 試合
  - 三槓子: 141 試合
  - 清老頭: 103 試合
  - 緑一色: 88 試合
  - 九蓮宝燈: 69 試合
  - 国士無双１３面: 50 試合
  - 大四喜: 24 試合
  - 純正九蓮宝燈: 5 試合
  - 四槓子: 2 試合
  - 人和: 0 試合
  - 場風 北: 0 試合
- 対象: 小四喜、四暗刻単騎、字一色、三槓子、清老頭、緑一色、九蓮宝燈、国士無双１３面、大四喜、純正九蓮宝燈、四槓子、人和、場風 北

#### 2. 戦略的非制御性（不確定要素）

意思決定時点の観測情報と結果の間に論理的な因果関係が成立せず、エージェントの構想力を評価する上でノイズとなる要素を排除する。

- 偶然による成立: 一発、槍槓、嶺上開花、海底摸月、河底撈魚、両立直、天和、地和
  - 除外の理由: これらは牌山の配列や他家の打牌タイミングに依存しており、打ち手の技術や意図による制御が不可能であるため。これらを予測対象に含めることは、純粋な「役の構想力」の評価を妨げる要因となる。
- 不可視情報: 裏ドラ
  - 除外の理由: 意思決定時点において物理的に観測不能な情報に基づく事後報酬であり、戦略的な牌の選択と直接的な因果関係を持たないため。
