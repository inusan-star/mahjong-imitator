## 1. データセット構築 (Dataset Construction)

本研究では、既存研究におけるデータ規模と再現性の課題を解決し、大規模モデルの学習に適した信頼性の高いデータセットを構築した。既存研究では打牌・ポン・チーの各ネットワークごとに合計 1,700,000 局面（内訳：打牌 1,400,000 局面 、ポン 160,000 局面 、チー 140,000 局面 ）が使用されているが、本研究では「カン」を含む全ての行動局面を対象とし、データ規模を大幅に拡大している。

### 既存研究との比較と定義

| 項目                 | 既存研究の記述                               | 本研究の定義                                     |
| :------------------- | :------------------------------------------- | :----------------------------------------------- |
| **データソース**     | オンライン麻雀「天鳳」トッププレイヤーの牌譜 | 「天鳳」鳳凰卓（最高段位専門）の2024年全対局ログ |
| **データセット母数** | 不明                                         | **317,531 試合** (2024年全データ)                |
| **データセット量**   | 1,700,000 局面                               | **XXX 局面** (打牌・ポン・チー・カンを含む)      |
| **抽出の網羅性**     | 打牌・ポン・チー                             | 打牌・ポン・チー・**明槓・暗槓・加槓**           |
| **サンプリング手法** | 明記なし                                     | 希少役の分布を維持する層化抽出                   |

### 抽出条件 (Data Extraction)

本研究では「和了役の構想（意図）の学習」を純粋化するため、抽出条件を以下のように定義した。

- **対象局:** **和了（アガリ）が発生した局のみ**を抽出。流局および途中流局は、最終的な正解ラベル（完成形）が不確定であり、プレイヤーの意図を正確に定義できないため除外する。
- **対象局面:** 和了者の視点における、配牌から和了直前までの**「打牌選択時」および「副露（ポン・チー・カン）選択時」の全ステップ**を抽出する。
- **定義の理由:** 既存研究では考慮されていない「カン（暗槓・大明槓・加槓）」の判断を含めることで、役の確定（三槓子等）や打点向上、ドラ増加を伴う戦略的選択を包括的に学習可能とする。

### データ分割 (Data Splitting)

統計的有意性を確保するため 100,000 半荘を抽出し、以下の比率で分割する。分割は、同一半荘内の局面が訓練・評価間で混在し、未来の情報を参照してしまうリーク（Data Leakage）を防ぐため、**半荘単位**で行う。

- **Train (学習):** 80,000 半荘
- **Valid (検証):** 10,000 半荘
- **Test (評価):** 10,000 半荘

### 層化抽出（Stratified Sampling）に基づく分布制約付き分割の手順

麻雀の役は出現頻度の差が極端に大きく、単純なランダム抽出では稀少役が評価データから消失する。これを防ぐため、2024年の全対局データ（317,531試合）から、特定の役の分布を維持したまま $N = 100,000$ 半荘を抽出し、再現可能な分割を実施する。本手法は厳密な意味での層化抽出ではなく、複数ラベルを持つ半荘データに対して、役分布を制約条件として満たすよう設計された貪欲的割当アルゴリズムである。

#### 1. 希少性の特定

2024年の全317,531試合を対象に、各役 $l \in L$ の出現総数 $C_l^{total}$ を算出する。出現数が少ない順に役をソートし（例：三槓子 $18$回、三色同刻 $459$回等）、この順序を抽出および割り当ての優先順位とする。

#### 2. 目標数の設定

抽出目標である $N=100,000$ 半荘における各役の期待出現数 $E_l$ を、全データにおける出現率に基づき以下のように算出する。
$$E_l = \frac{C_l^{total}}{317,531} \times 100,000$$
各セット $j \in \{Train, Valid, Test\}$ への分割比率 $w_j \in \{0.8, 0.1, 0.1\}$ に対し、各セット内での役ごとの最終目標数 $Goal_{j,l} = E_l \times w_j$ を定義する。出現期待値が $1$ 未満となる役については、評価セット（Test）に最低 $1$ 半荘以上含まれることを優先制約条件として調整する。

#### 3. 優先抽出と割り当ての監視

全317,531試合の中から、優先順位が高い（希少な）役 $l^*$ を含む半荘 $h$ を優先的に走査する。抽出した半荘の合計が 100,000 に達するまで、以下の基準で各セット $j$ へ割り当てる。

- 半荘 $h$ に複数の役が含まれる場合は、全体出現数が最小の役をその半荘の代表役 $l^*$ として扱う。
- 各セット $j$ における役 $l^*$ の現在の充足率 $S_{j,l^*} = \frac{CurrentCount_{j,l^*}}{Goal_{j,l^*}}$ を比較する。
- $S_{j,l^*}$ が最も低い（目標に対して不足している）セット $j$ に半荘 $h$ を割り当てる。

#### 4. 分布の動的更新

1つの半荘 $h$ が割り当てられるたびに、その半荘に含まれる「全ての役」について各セットの現在のカウント $CurrentCount_{j,l}$ を更新し、次ステップの充足率計算に反映させる。抽出数が 100,000 半荘に達した時点で処理を終了する。これにより、母集団の分布を維持したまま、希少役を評価データまで確実に行き渡らせる分割を実現する。

---

## 2. 予測対象ラベルの定義と分類基準

本研究の目的は、プレイヤーが「意図的・戦略的に形成を目指した役」を予測することにある。そのため、全役を以下の2つの観点から整理し、予測対象を選定する。

### 予測対象とする役

現状の観測可能な局面情報から論理的に導出でき、かつプレイヤー自身の能動的な選択（打牌・副露・立直宣言）によって制御可能な以下の役を対象とする。

- 門前清自摸和、立直、平和、断幺九、一盃口、自風 東、自風 南、自風 西、自風 北、場風 東、場風 南、場風 西、役牌 白、役牌 發、役牌 中、七対子、混全帯幺九、一気通貫、三色同順、三色同刻、三槓子、対々和、三暗刻、小三元、混老頭、二盃口、純全帯幺九、混一色、清一色、ドラ、赤ドラ

### 除外対象とする役

除外対象は、「統計的欠損」および「戦略的非制御性」の2つの方面から定義する。

#### 1. 統計的欠損による除外（出現数 0 件）

2024年度の全ログ（317,531 試合）を解析した結果、出現数が 0 件であった以下の役は、モデルが学習・評価するための統計的有意性を確保できないため、一律で除外する。

- **対象:** 場風 北、天和、地和、大三元、四暗刻、四暗刻単騎、字一色、緑一色、清老頭、九蓮宝燈、純正九蓮宝燈、国士無双、国士無双１３面、大四喜、小四喜、四槓子

#### 2. 戦略的非制御性による除外

以下の役は、「意思決定時の観測不可能性」および「事後的な確率依存性」という客観的基準に基づき、プレイヤーの戦略的意図の範疇外として除外する。

- **受動的・事象依存的要素:** 一発、槍槓、嶺上開花、海底摸月、河底撈魚、両立直
  - **定義:** これらは牌山の配列、または他家の打牌タイミングという「環境的偶発性」によって成立する。両立直についても、配牌と第一ツモという初期状態にのみ依存し、本研究が対象とする「中盤以降の打牌選択を通じた構構」を含まないため、エージェントの戦略性を評価する上ではノイズと定義し排除する。
- **隠匿情報・非操作的要素:** 裏ドラ
  - **定義:** 意思決定時点において物理的に観測不可能な情報に基づく報酬である。立直という選択自体は能動的であるが、結果としての裏ドラの有無は意思決定モデルの出力（意図）と論理的な因果関係を持たない。
- **除外の妥当性:** トップカンファレンス等の専門的知見において、AIの評価指標は「エージェントの制御可能なパラメータ」に収束させるべきである。したがって、これら不確定要素を排除することで、純粋な「手牌構成力」と「役の構想力」に特化したモデル評価が可能となる。
