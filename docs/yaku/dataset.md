## 1. データセット構築

### データ概要

| 項目                 | 既存研究             | 本研究                                   |
| :------------------- | :------------------- | :--------------------------------------- |
| **期間**             | 不明                 | 約10年間（2015年-2024年）                |
| **対象プレイヤー**   | 天鳳トッププレイヤー | 天鳳 鳳凰卓                              |
| **対象行動**         | 打牌・ポン・チー     | 打牌・ポン・チー・明槓・暗槓・加槓・立直 |
| **データ母数**       | 不明                 | 14,161,859 局                            |
| **学習・評価使用量** | 1,700,000 局面       | 1,000,000 局                             |

### 抽出条件

- 対象局の限定
  - 既存研究: 明記なし
  - 本研究: 和了（アガリ）発生局のみを抽出
  - 理由: 流局時は最終的な正解ラベル（役構成）が不確定であり、意思決定と結果の因果関係を客観的に定義できないため。
- 対象局面の定義
  - 既存研究: 打牌・ポン・チー
  - 本研究: 和了者の視点における、配牌から和了直前までの全意思決定ステップ（打牌・副露・暗槓・加槓・立直）を抽出。
  - 理由: 和了という結果に至るまでの過程において、プレイヤーが介在させた全ての判断を網羅的に学習させるため。また、カンの判断（暗槓・加槓・大明槓）がもたらす新ドラによる打点向上や、三槓子といった特定の役形成を狙う戦略的な選択肢を包括的に評価するため。
- 抽出対象外
  - 流局、途中流局（九種九牌、四風連打、四家立直、四槓散了、三家和）

### データ分割

- 分割単位: 同一の局内における局面が訓練・評価データ間で混在することを防ぐため、局単位で分割。
- 構成: 合計 1,000,000 局を抽出。
  - 訓練用 (Train): 900,000 局
  - 検証用 (Valid): 50,000 局
  - 評価用 (Test): 50,000 局

### 希少役分布維持のための割当手順

母集団からの単純なランダム抽出では、出現頻度が極端に低い役が評価データから消失するリスクがある。これを防ぐため、以下の数理モデルを用いて、不足している役を優先的に各セットへ割り振る手順により、全14,161,859局から1,000,000局を抽出し、各分割セットにおいて母集団の役分布を再現する。

1. 母集団からの抽出手順: 各役 $l$ の出現総数を $C_l^{total}$ としたとき、希少度を $R_l = 1 / C_l^{total}$ と定義します。また、この希少度に基づき、出現頻度が低い順にランキング $Rank_l \in \{1, 2, \dots, |L|\}$ を付与します。母集団の中から、各役の出現率を維持したまま1,000,000局を抽出するため、各局をランダムな順序で走査します。
2. 目標数 $G_{j,l}$ の算出: 各セット $j$ の割当比率 $w_j$ に対し、役 $l$ の目標数を次式で定義する。
   $$G_{j,l} = \frac{C_l^{total}}{14,161,859} \times 1,000,000 \times w_j$$
3. 抽出の充足判定: 役 $l$ の現在の全セットにおける合計抽出数を $Count_{all,l}$ としたとき、充足状態 $F_l$ を以下のように定義します。
   $$
   F_l =
   \begin{cases}
   1 & (\text{if } Count_{all,l} \ge \sum_j G_{j,l}) \\
   0 & (\text{otherwise})
   \end{cases}
   $$
4. 代表役 $l^*$ の選定と割当: 各局 $h$ に含まれる役の集合 $L_h$ のうち、まだ目標数に達していない（$F_l = 0$）役の中で最も希少度が高いものを代表役 $l^*$ として選択します。
   $$l^* = \text{argmax}_{l \in \{ \lambda \in L_h \mid F_\lambda = 0 \}} (R_l)$$
   代表役 $l^*$ のセットごとの充足率 $S_{j,l^*} = Count_{j,l^*} / G_{j,l^*}$ が最も低いセット $j$ に対して局 $h$ を割り当てます。もし集合 $\{ \lambda \in L_h \mid F_\lambda = 0 \}$ が空集合である（＝含まれる全ての役が目標数に達している）場合、その局は希少役の抽出対象から除外します。

5. 状態変数の更新と充足率の再評価: 局 $h$ をセット $j$ へ割り当てた直後、以下の各変数を更新し、システムの状態を遷移させます。
   - セット $j$ における全出現役のカウント更新: $Count_{j,l} \leftarrow Count_{j,l} + 1 \quad (\forall l \in L_h)$
   - セット $j$ の総抽出局数の更新: $N_j \leftarrow N_j + 1$
   - 役 $l$ のグローバル抽出合計数の更新: $Count_{all,l} = \sum_{k \in \{Train, Valid, Test\}} Count_{k,l}$
     この更新により、手順3の充足状態 $F_l$ が動的に変化します。代表役 $l^*$ 以外の役 $l \in L_h$ についてもカウントが加算されるため、出現頻度の高い役が意図せず過剰に抽出されるのを抑制するフィードバック機構として機能します。

6. 容量制限（ハードリミット）の遵守と例外処理: 各セット $j$ の総局数 $N_j$ には、割当比率に基づく定員上限（900,000 / 50,000 / 50,000）を設定します。
   - セットの優先順位とフォールバック: 代表役 $l^*$ の充足率 $S_{j,l^*}$ が最小のセット $j$ が既に定員（$N_j \ge 1,000,000 \times w_j$）に達している場合、次点に充足率が低い空きのあるセット $k$ へ局 $h$ を割り当てます。
   - 理由: 役ごとの理想的な分配（$G_{j,l}$）を試みつつも、データ分割の物理的制約（$N_{train}:N_{valid}:N_{test} = 18:1:1$）を最優先で確定させるためです。

7. 終了条件: 以下のいずれかの条件を満たした時点で、当該アルゴリズムによる抽出処理を終了します。
   - 総抽出数の到達: 全セットの合計抽出局数が目標数に達した場合。
     $$\sum_{j \in \{Train, Valid, Test\}} N_j = 1,000,000$$
   - 候補局の枯渇: 母集団 14,161,859 局の全走査が完了した場合。
   - 分配最適化の終了: 走査中の局 $h$ に含まれるすべての役 $l \in L_h$ について $F_l = 1$ となった場合。手順4のスキップ条件により、これ以降の局を抽出することは、データセット全体の役分布を母集団の比率から逸脱させる（頻出役が過剰になる）原因となるため、原則として抽出を行いません。

---

## 2. 予測対象ラベルの定義と分類基準

### 予測対象

プレイヤーの能動的な選択によって制御可能な、合計 33 種類の役およびドラを予測対象ラベルとする。

- 基本役（5種）: 門前清自摸和、立直、平和、断幺九、一盃口
- 構成役（12種）: 七対子、混全帯幺九、一気通貫、三色同順、三暗刻、純全帯幺九、混一色、清一色、小三元、混老頭、二盃口、三色同刻、対々和
- 役牌（10種）: 自風(東/南/西/北)、場風(東/南/西)、三元牌(白/發/中)
- ドラ（2種）: ドラ、赤ドラ
- 役満（3種）: 四暗刻、国士無双、大三元

### 除外対象

#### 1. 統計的欠損（出現極少・無）

全 14,161,859 局を解析した結果、出現頻度が極めて低く、モデルの評価指標を算出するための最小サンプルサイズを確保できない役を除外する。

- 境界閾値: 出現数 1,416 局未満（出現率 約 0.01% 未満）
- 除外の理由: 本研究では評価データ（50,000 局）において、たった1件の正誤で指標が極端に変動するのを防ぎ、統計的信頼性を担保するための境界条件を定義しました。この比率を母集団（14,161,859 局）に適用すると、出現数が約 1,416 局を下回る役は、十分なサンプルサイズを確保できず精度の正しい測定が困難であるため、除外を決定しました。
- 母集団における出現数実績（除外例）:
  - 小四喜: 919 局
  - 四暗刻単騎: 737 局
  - 字一色: 180 局
  - 三槓子: 141 局
  - 清老頭: 103 局
  - 緑一色: 88 局
  - 九蓮宝燈: 69 局
  - 国士無双１３面: 50 局
  - 大四喜: 24 局
  - 純正九蓮宝燈: 5 局
  - 四槓子: 2 局
  - 人和: 0 局
  - 場風 北: 0 局
- 対象: 小四喜、四暗刻単騎、字一色、三槓子、清老頭、緑一色、九蓮宝燈、国士無双１３面、大四喜、純正九蓮宝燈、四槓子、人和、場風 北

#### 2. 戦略的非制御性（不確定要素）

意思決定時点の観測情報と結果の間に論理的な因果関係が成立せず、エージェントの構想力を評価する上でノイズとなる要素を排除する。

- 偶然による成立: 一発、槍槓、嶺上開花、海底摸月、河底撈魚、両立直、天和、地和
  - 除外の理由: これらは牌山の配列や他家の打牌タイミングに依存しており、打ち手の技術や意図による制御が不可能であるため。これらを予測対象に含めることは、純粋な「役の構想力」の評価を妨げる要因となる。
- 不可視情報: 裏ドラ
  - 除外の理由: 意思決定時点において物理的に観測不能な情報に基づく事後報酬であり、戦略的な牌の選択と直接的な因果関係を持たないため。
